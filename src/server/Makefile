#List of files and their meaning and usage
#	Private keys. Files ending in .pem are private keys.
# 	server.pem:
#			Private key of the server hosting the "simple.dev" domain name.
# 	root.pem:
#			Private key of a fictitious root authority.
# 	ocsp_responder.pem:
#			Private key of the server hosting the ocsp_responder.
# 	intermediate.pem:
#			Private key of the intermediate certificate authority.

#	Certificate signing requests. Files ending in .csr are signing requests in X.509 format.
#		ocsp_responder.csr
#			This request is from the ocsp responder to the root authority, requesting that their identity as a trusted ocsp responder
#			is recognized. The domain name of the ocsp responder is certificate.authority.
#		intermediate.csr
#			This request is from the intermediate authority to the root authority, asking to be recognized as an intermediate authority.
#		root.csr
#			This request is from the root authority to itself to recognize itself as the root authority.

#	Certificate signing request configuration files. Files ending in _csr.conf are openssl configuration files for generating
#	the .csr signing requests.
#		ocsp_responder_csr.conf
#		intermediate_csr.conf
#		root_csr.conf
#		server_csr.conf

#	Certificates. Files ending in .crt are X.509 certificates. Files ending in _bundle.crt contain multiple certificates
# concatenated together.
#		intermediate_and_root_bundle.crt
#		server_bundle.crt
#		server.crt
#		ocsp_responder.crt
#		intermediate.crt
#		root.crt

# Configuration files for root authorities when using the openssl ca command
#		root_ca.conf (Refers to root_serial_numbers.txt and root_database.txt)
#			

# Database files. OpenSSL relies on certain text-based database files to exist in order to implement the certificate authority that is used to
# generate the .crt files. Except for some files with a .attr extension, the file names are chosen by the developer.
#		root_database.txt
#		root_database.txt.attr
#		root_serial_numbers.txt
#		intermediate_database.txt
#		intermediate_database.txt.attr
#		intermediate_serial_numbers.txt

# Directories. Connected with the use of OpenSSL certificate authorities, some directories need to exist to provide
# a location to store various pieces of information generated by OpenSSL commands.
#	Intermediate certificates are stored in "intermediate_certificates".
#	server_certificates ??
# The root certificate authority certificates are stored in the directory "root_certificates".

intermediate_and_root_bundle.crt: intermediate.crt root.crt
	cat intermediate.crt root.crt > intermediate_and_root_bundle.crt

server_bundle.crt: server.crt intermediate.crt root.crt
	cat server.crt intermediate.crt root.crt > server_bundle.crt

server.crt: server.csr sign_server_by_intermediate.conf intermediate.pem intermediate.crt
	openssl ca -in server.csr -out server.crt -config sign_server_by_intermediate.conf -keyfile intermediate.pem -outdir server_certificates -cert intermediate.crt -batch

server.csr: server.pem server_csr.conf
	openssl req -key server.pem -out server.csr -days 398 -new -config server_csr.conf

ocsp_responder.crt: ocsp_responder.csr ocsp_responder_csr.conf root.pem root.crt
	openssl ca -in intermediate.csr -out intermediate.crt -config intermediate_csr.conf -keyfile root.pem -cert root.crt -outdir intermediate_certificates -batch


ocsp_responder.csr: ocsp_responder.pem ocsp_responder_csr.conf root.pem root.crt
	openssl req -key ocsp_responder.pem -in root.crt -days 398 -new -config ocsp_responder_csr.conf -out ocsp_responder.csr

#DONE VVV
intermediate_certificate: intermediate.crt intermediate.csr

#retain blank line
intermediate.crt: intermediate.csr intermediate_csr.conf root.pem root.crt
	openssl ca -in intermediate.csr -out intermediate.crt -config intermediate_ca.conf -keyfile root.pem -cert root.crt -outdir intermediate_certificates -batch

intermediate.csr: intermediate.pem root.crt intermediate_csr.conf
	openssl req -key intermediate.pem -in root.crt -days 398 -new -config intermediate_csr.conf -out intermediate.csr


root_certificate: root.crt root.csr

#blank line required here
root.crt: root.csr root_ca.conf
	openssl ca -selfsign -keyfile root.pem -config root_ca.conf -out root.crt -in root.csr -outdir root_certificates -verbose -batch

root.csr: root.pem  root_csr.conf
	openssl req -key root.pem -out root.csr -days 398 -new -config root_csr.conf

private_keys: server.pem ocsp_responder.pem intermediate.pem root.pem

server.pem:
	openssl genpkey -outform pem -out server.pem -algorithm rsa

ocsp_responder.pem:
	openssl genpkey -outform pem -out ocsp_responder.pem -algorithm rsa

intermediate.pem:
	openssl genpkey -outform pem -out intermediate.pem -algorithm rsa

root.pem:
	openssl genpkey -outform pem -out root.pem -algorithm rsa

#DONE ^^^

server_csr.conf:
	@echo "empty rule"

intermediate_csr.conf:
	@echo "empty rule"

clean_keys:
	rm *.pem

clean:
	rm -f root_database.txt*
	touch root_database.txt root_database.txt.attr
	rm -rf root_certificates
	mkdir root_certificates
	rm -f intermediate_database.txt
	touch intermediate_database.txt
	rm -rf intermediate_certificates
	mkdir intermediate_certificates
	rm -f root.pem intermediate.pem server.pem
	rm -f root.csr root.crt
	rm -f intermediate.csr
	rm -f intermediate.crt
	rm -f server.csr
	rm -f server.crt
	rm -f server_certificates/*.pem
	rm -f root_serial_numbers.txt*
	echo 01 > root_serial_numbers.txt
	rm -f intermediate_serial_numbers.txt
	echo 01 > intermediate_serial_numbers.txt

.PHONY: clean clean_keys private_keys directories root_certificate

directories:
	mkdir root_certificates intermediate_certificates